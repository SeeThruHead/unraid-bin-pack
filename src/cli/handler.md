# Command Handlers

Command implementations for the unraid-bin-pack CLI.

## Overview

The handler module contains the main command implementations (`plan`, `apply`, `show`) and orchestrates the entire consolidation workflow from disk scanning to plan generation.

## Commands

### plan

Creates a consolidation plan by:

1. Discovering or validating disk paths
2. Scanning all files on specified disks
3. Running the consolidation algorithm
4. Validating the plan with a dry-run
5. Generating a bash script for execution

```typescript
export const runPlan = (
  options: PlanOptions,
  isInteractive?: boolean
) => Effect<void, never, DiskService | FileSystem | ...>
```

**Key Features:**

- Interactive mode with disk discovery and prompts
- Automatic disk discovery via `/mnt/disk*` pattern
- Dry-run validation before saving plan
- Generates executable bash script with rsync commands
- Prevents overwriting existing plans (use `--force` to override)

**Usage Example:**

```typescript
import { Effect } from "effect";
import { runPlan, withErrorHandling, AppLive } from "./handler";

// Non-interactive mode
const program = runPlan({
  src: "/mnt/disk1",
  dest: "/mnt/disk2,/mnt/disk3",
  minSpace: "100GB",
  minFileSize: "1MB",
  exclude: ".DS_Store,@eaDir",
  planFile: "/config/plan.sh",
  force: false,
  debug: false
}).pipe(withErrorHandling, Effect.provide(AppLive));

Effect.runPromise(program);
```

### apply

Executes a previously generated plan script.

```typescript
export const runApply = (options: ApplyOptions) => Effect<void, never, LoggerService | FileSystem>;
```

**Features:**

- Executes the bash script generated by `plan`
- Supports dry-run mode to preview execution
- Default plan path: `/config/plan.sh`

**Usage Example:**

```typescript
import { runApply, withErrorHandling, AppLive } from "./handler";

// Execute plan
const program = runApply({
  planFile: "/config/plan.sh",
  concurrency: 4,
  dryRun: false
}).pipe(withErrorHandling, Effect.provide(AppLive));

// Dry run preview
const dryRun = runApply({
  planFile: "/config/plan.sh",
  concurrency: 4,
  dryRun: true
}).pipe(withErrorHandling, Effect.provide(AppLive));
```

### show

Displays the contents of a saved plan script.

```typescript
export const runShow = (options: { planFile: string | undefined }) =>
  Effect<void, never, FileSystem>;
```

**Usage Example:**

```typescript
import { runShow, withErrorHandling, AppLive } from "./handler";

const program = runShow({
  planFile: "/config/plan.sh"
}).pipe(withErrorHandling, Effect.provide(AppLive));
```

## Helper Functions

### buildWorldViewAndPlan

Internal helper that orchestrates the consolidation workflow.

```typescript
const buildWorldViewAndPlan = (allDisks: Disk[], options: ConsolidationConfig) =>
  Effect<
    {
      initialDiskStats: DiskSnapshot[];
      finalDiskStats: DiskSnapshot[];
      moves: FileMove[];
      disksEvacuated: number;
    },
    never,
    ScannerService
  >;
```

**Process:**

1. Scans all files on specified disks
2. Builds initial WorldView
3. Runs consolidation algorithm
4. Optimizes move chains (removes redundant moves)
5. Projects final disk states

### withErrorHandling

Wraps effects with user-friendly error handling.

```typescript
export const withErrorHandling = <A, R>(effect: Effect<A, unknown, R>) => Effect<void, never, R>;
```

Converts domain errors to formatted AppError messages.

## Dependency Injection

### createAppLayer / AppLive

Creates the Effect layer with all required services.

```typescript
export const createAppLayer = () =>
  Layer<DiskService | ScannerService | TransferService | LoggerService | PlanGeneratorService>;

export const AppLive = createAppLayer();
```

**Included Services:**

- LoggerService - Structured logging
- DiskService - Disk validation and discovery
- ScannerService - File scanning
- TransferService - rsync execution
- PlanGeneratorService - Bash script generation

**Usage:**

```typescript
import { Effect } from "effect";
import { runPlan, AppLive } from "./handler";

const program = runPlan(options).pipe(Effect.provide(AppLive));
```

## Interactive Mode

When `isInteractive: true`, the plan command:

1. Auto-discovers disks at `/mnt/disk*`
2. Displays disk information (size, usage, free space)
3. Prompts for all configuration options
4. Includes directory tree selection

```typescript
// Enable interactive mode
const program = runPlan(baseOptions, true);
```

See [interactive.md](./interactive.md) for prompt details.

## Workflow

### Plan Generation Flow

```
1. Validate/discover disk paths
   ↓
2. Scan files on all disks
   ↓
3. Build WorldView (disks + files)
   ↓
4. Run consolidation algorithm
   ↓
5. Optimize move chains
   ↓
6. Dry-run validation
   ↓
7. Generate bash script
   ↓
8. Save to plan file (chmod +x)
```

### Plan Execution Flow

```
1. Check plan file exists
   ↓
2. Read script content
   ↓
3. Execute with bash
   ↓
4. Report completion
```

## Error Handling

All commands use `withErrorHandling` wrapper to convert domain errors to user-friendly messages:

- **DiskError** → Path validation errors with suggestions
- **ScannerError** → File scanning errors with permission hints
- **TransferError** → rsync execution errors with installation hints

Example error output:

```
ERROR: Disk not found

   The path "/mnt/disk1" does not exist.

   Hint: Make sure the disk is mounted. On Unraid, check that
   the disk appears in Main > Array Devices.
```

## See Also

- [interactive.md](./interactive.md) - Interactive mode prompts
- [options.md](./options.md) - CLI option definitions
- [errors.md](./errors.md) - Error handling and AppError
- [SimpleConsolidator.md](../services/BinPack/SimpleConsolidator.md) - Consolidation algorithm
- [PlanScriptGenerator.md](../services/PlanScriptGenerator/PlanScriptGenerator.md) - Bash script generation
